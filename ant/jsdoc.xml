<project name="jsdoc" default="build-jsdoc" basedir="..">
    <property environment="env"/>
    <import file="${basedir}/build.xml"/>

    <target name="build-jsdoc" depends="init">

        <!-- Working directory for jsdoc api -->
        <property name="jsdoc.tmp" value="${java.io.tmpdir}/jsdoc"/>
        <delete dir="${jsdoc.tmp}"/>
        <mkdir dir="${jsdoc.tmp}"/>

        <echo level="info">Copying jsdoc assets docs to ${jsdoc.tmp}</echo>

        <copy todir="${jsdoc.tmp}">
            <fileset file="${basedir}/js/qz-tray.js"/>
            <fileset file="README.md"/>
        </copy>

        <!-- Allow templates via TEMPLATE_DIR if provided -->
        <condition property="jsdoc.template" value="--template &quot;${env.TEMPLATE_DIR}&quot;">
            <isset property="env.TEMPLATE_DIR"/>
        </condition>
        <property description="suppress-property-warning" name="jsdoc.template" value=""/>

        <!-- Handle JSDOC_OUT_DIR if provided -->
        <condition property="jsdoc.out" value="${env.JSDOC_OUT_DIR}">
            <isset property="env.JSDOC_OUT_DIR"/>
        </condition>
        <property description="suppress-property-warning" name="jsdoc.out" value="${jsdoc.tmp}/api"/>
        <delete dir="${jsdoc.out}"/>

        <!-- Fix GitHub links -->
        <replace file="${jsdoc.tmp}/README.md">
            <replacefilter token="../../" value="https://github.com/qzind/tray/"/>
        </replace>
        <replace file="${jsdoc.tmp}/README.md">
            <replacefilter token="https://github.com/qzind/tray/wiki/" value="../../docs/"/>
        </replace>

        <exec executable="jsdoc" failonerror="true">
            <arg value="${jsdoc.tmp}/qz-tray.js"/>
            <arg value="--readme"/>
            <arg value="${jsdoc.tmp}/README.md"/>
            <arg value="--destination"/>
            <arg value="${jsdoc.out}"/>
            <arg line="${jsdoc.template}"/>
        </exec>

        <tar destfile="${jsdoc.out}.tar" basedir="${jsdoc.out}"/>
        <gzip destfile="${jsdoc.out}.tar.gz" src="${jsdoc.out}.tar"/>
        <delete file="${jsdoc.out}.tar"/>
    </target>
</project>